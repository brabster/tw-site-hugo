<!doctype html><html lang=en data-theme=dark><head><title>Paul Brabban | Performance with Spring Boot and Gatling (Part 2)</title><meta charset=utf-8><meta name=generator content="Hugo 0.69.0"><meta name=viewport content="width=device-width,initial-scale=1,viewport-fit=cover"><meta name=description content="Software and Data Consulting Services"><link rel=stylesheet href=/css/style.min.e332b070abdcc736bb1e21feb22a6be1524dcddef4e12f6d5d569adfb8dcb51a.css integrity="sha256-4zKwcKvcxza7HiH+sipr4VJNzd704S9tXVaa37jctRo=" crossorigin=anonymous type=text/css><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css integrity="sha512-+4zCK9k+qNFUR5X+cKL9EIR+ZOhtIloNl9GIKS57V1MyNsYpYcUrUeQc9vNfzsWfV28IaLL3i96P9sdNyeRssA==" crossorigin=anonymous><link rel="shortcut icon" href=/favicons/favicon.ico type=image/x-icon><link rel=apple-touch-icon sizes=180x180 href=/favicons/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicons/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicons/favicon-16x16.png><link rel=canonical href=/posts/2019-01-17-spring-boot-performance-part-2/><script type=text/javascript src=/js/anatole-header.min.e782db136ec18d105a4552702eac49f4620d6867da3fbf808bd53e806c96be6e.js integrity="sha256-54LbE27BjRBaRVJwLqxJ9GINaGfaP7+Ai9U+gGyWvm4=" crossorigin=anonymous></script><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="47"><meta name=twitter:title content="Performance with Spring Boot and Gatling (Part 2)"><meta name=twitter:description content="Tracking down a performance problem - (Threads | Sessions | Passwords)?"></head><body><div class="sidebar animated fadeInDown"><div class=logo-title><div class=title><img src=/about/profile.jpeg alt="profile picture"><h3><a href=/>Tempered Works</a></h3><div class=description><p>Software and Data Consulting Services</p></div></div></div><ul class=social-links><li><a href=https://linkedin.com/in/paulbrabban rel=me aria-label=Linkedin><i class="fab fa-linkedin fa-2x" aria-hidden=true></i></a></li><li><a href=https://github.com/brabster rel=me aria-label=GitHub><i class="fab fa-github fa-2x" aria-hidden=true></i></a></li><li><a href=https://twitter.com/brabster rel=me aria-label=instagram><i class="fab fa-twitter fa-2x" aria-hidden=true></i></a></li><li><a href=mailto:paul@tempered.works rel=me aria-label=e-mail><i class="fas fa-envelope fa-2x" aria-hidden=true></i></a></li></ul><div class=footer><div class=by_farbox>&copy; Paul Brabban 2020</div></div></div><div class=main><div class="page-top animated fadeInDown"><a role=button class=navbar-burger data-target=navMenu aria-label=menu aria-expanded=false><span aria-hidden=true></span><span aria-hidden=true></span><span aria-hidden=true></span></a><ul class=nav id=navMenu><li><a href=/>Home</a></li><li><a href=/posts/>Posts</a></li><li><a href=/about/>About</a></li><li class=theme-switch-item><a class=theme-switch title="Switch Theme"><i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></li></ul></div><div class=autopagerize_page_element><div class=content><div class="post animated fadeInDown"><div class=post-content><div class=post-title><h3>Performance with Spring Boot and Gatling (Part 2)</h3></div><p>In <a href=/posts/spring-boot-performance-part-1>Part 1</a>, we built a simple Spring Boot webapp and demonstrated a surprising performance problem.
A Gatling performance test simulating different numbers of users each making a single request showed our webapp unable to keep up with 40 &ldquo;users&rdquo; making one request per second on my fairly powerful computer.</p><p>We eliminate a couple of potential causes in the first part of the article. If you just want to know what was causing the problem, you can <a href=#password-encoding>go straight there</a>.</p><p>We&rsquo;ve already eliminate many potential culprits, so we continue using a process of elimination to figure out what&rsquo;s causing the problem. I shared a link to the first part and invited people to guess what the problem was.</p><p>Thread starvation was amongst the guesses, so let&rsquo;s take a look.</p><h2 id=how-many-threads>How Many Threads?</h2><p>Spring Boot apps run in an embedded Tomcat server by default, so this is something we can look into.
If we were, say, talking to a slow database synchronously then it would seem more likely that we might be running out of threads to service new requests as exising requests keep threads waiting for responses from the database.</p><p>As it&rsquo;s easy, we&rsquo;ll see what happens if we increase the number of threads Tomcat can use. We can check the <a href=https://docs.spring.io/spring-boot/docs/current/reference/html/common-application-properties.html>documentation</a> to see that the default thread pool size is 200 threads and how to increase it.
We can increase that by an order of magnitude to 2000 threads in <code>application.properties</code>:</p><p><code>server.tomcat.max-threads=2000</code></p><p>Running our Gatling test shows that this change has adversely affected performance. We see more active users at peak and a funny dip in the actives line as the backlog is cleared. That dip, marked on the chart below, is a few requests timing out.</p><p><img src=1000-threads-req-sec.png alt="Requests per second and active users"></p><p>That didn&rsquo;t help, so let&rsquo;s put the max thread count back to the default before we try anything else! If you&rsquo;re following along, I recommend using <code>clean</code>, as in <code>mvn clean spring-boot:run</code> to ensure that nothing is remembered from the previous build. You can lose a lot of time acting on misleading results otherwise!</p><h2 id=json-encoding>JSON Encoding</h2><p>Another unlikely candidate is the JSON encoding we&rsquo;re doing on our responses. Out of the box, Spring Boot uses the venerable <a href=https://github.com/FasterXML/jackson>Jackson</a> library, but you never know, the default settings might be really inefficient. Again, it&rsquo;s really easy to check so let&rsquo;s find out. We update the controller so that instead of returning Java object containing a String, it returns just a plain string, so from:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>    <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Greeting</span> <span style=color:#f92672>{</span>
        <span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>getGreeting</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
            <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;Greetings from Spring Boot!&#34;</span><span style=color:#f92672>;</span>
        <span style=color:#f92672>}</span>
    <span style=color:#f92672>}</span>

    <span style=color:#a6e22e>@RequestMapping</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;/&#34;</span><span style=color:#f92672>)</span>
    <span style=color:#66d9ef>public</span> Greeting <span style=color:#a6e22e>index</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> Greeting<span style=color:#f92672>();</span>
    <span style=color:#f92672>}</span>
</code></pre></div><p>to:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>    <span style=color:#a6e22e>@RequestMapping</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;/&#34;</span><span style=color:#f92672>)</span>
    <span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>index</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
        <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;Greetings from Spring Boot!&#34;</span><span style=color:#f92672>;</span>
    <span style=color:#f92672>}</span>
</code></pre></div><p>If you make that change and run the Gatling test, you see&mldr;</p><p><em>&mldr;drum roll&mldr;</em></p><p>No detectable difference from the original results we got in part 1. Not really a surprise, JSON encoding isn&rsquo;t the problem.</p><h2 id=spring-security>Spring Security</h2><p>The next thing we can check easily is whether Spring Security is causing the problem somehow. Like the cases above, we&rsquo;ve got well tried and tested software running with Spring Boot&rsquo;s sensible defaults, so yet again, it seems unlikely. Something&rsquo;s causing the poor performance and Spring Security does lots of things though, like authentication and session management. We&rsquo;re running out of possible causes though so let&rsquo;s give it a try.</p><p>The quick and easy way to check whether something that Spring Security is autoconfiguring in is causing the problem is to just omit the dependency. Let&rsquo;s delete <code>spring-security-web</code> and <code>spring-security-config</code> from our <code>pom.xml</code>. We can see there&rsquo;s less happening on startup, but will it handle the load better? Let&rsquo;s run the test.</p><p><img src=no-spring-sec.gif alt="Asciicast with no spring security on the classpath"></p><p>We have a winner! You can see that the performance is improved. No active requests throughout the test - the app is keeping up easily. The charts tell the same story. Let&rsquo;s compare side by side to get a feel for the difference.</p><h3 id=response-time-distribution-before>Response time distribution, before:</h3><p><img src=../2019-01-07-spring-boot-performance-part-1/gatling-slow-response-time-distribution.png alt="Histogram of response time distributions, with Spring Security"></p><h3 id=response-time-distribution-after>Response time distribution, after:</h3><p><img src=no-spring-security-response-time-dist.png alt="Histogram of response time distributions, without Spring Security"></p><p>Instead of a spread of response times all the way up to 30 seconds, we have all responses served within a few milliseconds. Much better! On to requests per second.</p><h3 id=requests-per-second-and-active-users-before>Requests per Second and Active Users, before:</h3><p><img src=../2019-01-07-spring-boot-performance-part-1/gatling-slow-request-response-rate.png alt="Plots of requests per second and active users, with Spring Security"></p><h3 id=requests-per-second-and-active-users-after>Requests per Second and Active Users, after:</h3><p><img src=no-spring-security-req-sec.png alt="Plots of requests per second and active users, without Spring Security"></p><p>To appreciate the difference, note the different scale for Active Users, the y-axis on the right, and the total time the test ran for on the x-axis. Before, the number of active users climbed faster than the request rate, indicating that requests would start timing out if the test hadn&rsquo;t ended. After we remove Spring Security, the number of active users is the same as the request rate throughout the test, so the app is keeping up perfectly with the load.</p><h2 id=whats-causing-the-problem>What&rsquo;s causing the problem?</h2><p>Spring Security with Spring Boot <a href=https://docs.spring.io/spring-boot/docs/current/reference/html/boot-features-security.html>automatically applies sensible security settings to an app when it&rsquo;s on the classpath</a>. You take control of aspects of configuration through annotations and extending classes. As this is such a simple app, there&rsquo;s not too much to check. We&rsquo;ll take control of authentication and roughly replicate the automatic configuration with this <code>@Configuration</code> annotated class</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#a6e22e>@Configuration</span>
<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>SecurityConfig</span> <span style=color:#66d9ef>extends</span> WebSecurityConfigurerAdapter <span style=color:#f92672>{</span>

    <span style=color:#a6e22e>@Override</span>
    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>configure</span><span style=color:#f92672>(</span>HttpSecurity http<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> Exception <span style=color:#f92672>{</span>
        http<span style=color:#f92672>.</span><span style=color:#a6e22e>httpBasic</span><span style=color:#f92672>();</span>
    <span style=color:#f92672>}</span>

<span style=color:#f92672>}</span>
</code></pre></div><p>The Gatling test shows that the performance problem is back. Delete the <code>http.httpBasic()</code> line and the problem goes away. Something to do with authentication then. I didn&rsquo;t find anything in Spring Security or Spring Boot documentation to explain it.</p><p>I&rsquo;m not sure how you&rsquo;d figure it out if you didn&rsquo;t know where to start. GIven a little experience with passwords and authentication you can join the remaining dots. There&rsquo;s two things going on that could be responsible. Let&rsquo;s look at password encoding.</p><h3 id=password-encoding>Password Encoding</h3><p>We protect passwords for by &lsquo;encoding&rsquo; or &lsquo;hashing&rsquo; them before we store them. When the user authenticates, we encode the password they gave us and compare with our stored hash to see if the password was right.</p><p>The choice of encoding algorithm is important in this world of cloud computing, GPUs and hardware acceleration. We need an algorithm that needs a lot of CPU power to encode. We get a password encoder using the bcrypt algorithm by default, an algorithm that&rsquo;s been designed to withstand modern techniques and compute power. You can read more about bcrypt and how it helps keep your user database secure in <a href=https://auth0.com/blog/hashing-in-action-understanding-bcrypt>Auth0&rsquo;s article</a> and Jeff Attwood&rsquo;s post on <a href=https://blog.codinghorror.com/speed-hashing/>Coding Horror</a>.</p><p>See the connection yet? The choice of Bcrypt makes sense for protecting the credentials we&rsquo;re entrusted with, but do we do about this terrible performance?</p><h3 id=sessions>Sessions</h3><p>By default, the security config responds to our first authentication with a cookie containing a session ID. That is exchanged without any encoding. Sessions come with lots of problems of their own, so we&rsquo;ll leave that one for another day. If we&rsquo;d been using a browser, or Gatling had been set up to make lots of requests as the same user, we&rsquo;d have used the session ID and not seen a performance problem.</p><h2 id=reconfiguring-our-app>Reconfiguring our App</h2><p>We&rsquo;ll override the password encoder to prove that it is causing the performance problem. <em>As we&rsquo;re dealing with a hardcoded test password rather than real user passwords</em>, we don&rsquo;t need to worry about it not being secured. We update our <code>SecurityConfig</code> class like this:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#a6e22e>@Configuration</span>
<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>SecurityConfig</span> <span style=color:#66d9ef>extends</span> WebSecurityConfigurerAdapter <span style=color:#f92672>{</span>

    <span style=color:#75715e>// make the credentials in application.properties available
</span><span style=color:#75715e></span>    <span style=color:#a6e22e>@Value</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;${spring.security.user.name}&#34;</span><span style=color:#f92672>)</span>
    <span style=color:#66d9ef>private</span> String username<span style=color:#f92672>;</span>

    <span style=color:#a6e22e>@Value</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;${spring.security.user.password}&#34;</span><span style=color:#f92672>)</span>
    <span style=color:#66d9ef>private</span> String password<span style=color:#f92672>;</span>

    <span style=color:#a6e22e>@Override</span>
    <span style=color:#66d9ef>protected</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>configure</span><span style=color:#f92672>(</span>AuthenticationManagerBuilder auth<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> Exception <span style=color:#f92672>{</span>

        <span style=color:#75715e>// choose a more efficient (and far weaker) hashing algorithm
</span><span style=color:#75715e></span>        <span style=color:#66d9ef>final</span> PasswordEncoder sha256 <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> StandardPasswordEncoder<span style=color:#f92672>();</span>

        auth<span style=color:#f92672>.</span><span style=color:#a6e22e>inMemoryAuthentication</span><span style=color:#f92672>()</span>
                <span style=color:#f92672>.</span><span style=color:#a6e22e>passwordEncoder</span><span style=color:#f92672>(</span>sha256<span style=color:#f92672>)</span>
                <span style=color:#f92672>.</span><span style=color:#a6e22e>withUser</span><span style=color:#f92672>(</span>username<span style=color:#f92672>)</span>
                <span style=color:#f92672>.</span><span style=color:#a6e22e>password</span><span style=color:#f92672>(</span>sha256<span style=color:#f92672>.</span><span style=color:#a6e22e>encode</span><span style=color:#f92672>(</span>password<span style=color:#f92672>))</span>
                <span style=color:#f92672>.</span><span style=color:#a6e22e>roles</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;USER&#34;</span><span style=color:#f92672>);</span>
    <span style=color:#f92672>}</span>

    <span style=color:#a6e22e>@Override</span>
    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>configure</span><span style=color:#f92672>(</span>HttpSecurity http<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> Exception <span style=color:#f92672>{</span>
        http<span style=color:#f92672>.</span><span style=color:#a6e22e>httpBasic</span><span style=color:#f92672>();</span>
    <span style=color:#f92672>}</span>

<span style=color:#f92672>}</span>
</code></pre></div><p>When we run our performance test one last time, we see that we have performance and we have authentication. <a href=https://twitter.com/glenathan>@glenathan</a> takes the prize for correctly guessing the cause!</p><p>How fast can it go? When I push the request rate higher, I see that this app can actually handle around 2,000 requests per second. I won&rsquo;t bore you with more asciinema or the charts, but you can <a href=https://github.com/brabster/performance-with-spring-boot/tree/2.0>play with the updated app yourself</a> if you want.</p></div><div class=post-footer><div class=info><span class=separator><a class=tag href=/tags/web-development/>web-development</a><a class=tag href=/tags/performance-testing/>performance-testing</a><a class=tag href=/tags/spring-boot/>spring-boot</a><a class=tag href=/tags/spring-security/>spring-security</a><a class=tag href=/tags/gatling/>gatling</a><a class=tag href=/tags/java/>java</a><a class=tag href=/tags/scala/>scala</a></span></div></div></div></div></div></div><script type=text/javascript src=/js/jquery.min.86b1e8f819ee2d9099a783e50b49dff24282545fc40773861f9126b921532e4c.js integrity="sha256-hrHo+BnuLZCZp4PlC0nf8kKCVF/EB3OGH5EmuSFTLkw=" crossorigin=anonymous></script><script type=text/javascript src=/js/bundle.min.0f9c74cb78f13d1f15f33daff4037c70354f98acfbb97a6f61708966675c3cae.js integrity="sha256-D5x0y3jxPR8V8z2v9AN8cDVPmKz7uXpvYXCJZmdcPK4=" crossorigin=anonymous></script><script type=text/javascript src=/js/medium-zoom.min.92f21c856129f84aeb719459b3e6ac621a3032fd7b180a18c04e1d12083f8aba.js integrity="sha256-kvIchWEp+ErrcZRZs+asYhowMv17GAoYwE4dEgg/iro=" crossorigin=anonymous></script></body></html>